<div class="container-fluid p-1 mt-2 mb-2">
  <div class="m-2 p-1">
    <h1 class="text-left ps-4">Ingreso/Egreso de Visitantes</h1>
  </div>
  <div class="container-fluid m-1 p-2">
    <div class="container-fluid col-10">
      <!-- Contenedor para los botones alineados a la derecha -->
      <div class="d-flex justify-content-end botones">
        <button
          class="btn btn-primary me-2"
          data-bs-toggle="modal"
          data-bs-target="#qrScannerModal"
        >
          <i class="bi bi-qr-code-scan"></i>
        </button>
        <!-- Botón para cargar imagen de QR -->
        <button class="btn btn-primary me-2" (click)="uploadQrImage()">
          <i class="bi bi-file-earmark-arrow-up"></i>
        </button>
        <input
          type="file"
          accept="image/*"
          #qrInput
          hidden
          (change)="onFileSelected($event)"
        />
      </div>
      <table
        id="visitorsTable"
        class="display table border border-dark rounded"
      >
        <thead class="bg-secondary">
          <tr>
            <th scope="col" class="border border-dark text-light bg-secondary">
              Nombre
            </th>
            <th scope="col" class="border border-dark text-light bg-secondary">
              Tipo Doc.
            </th>
            <th scope="col" class="border border-dark text-light bg-secondary">
              Documento
            </th>
            <th scope="col" class="border border-dark text-light bg-secondary">
              Información
            </th>
            <th scope="col" class="border border-dark text-light bg-secondary">
              Accion
            </th>
            <th scope="col" class="border border-dark text-light bg-secondary">
              Observaciones
            </th>
            <th scope="col" class="border border-dark text-light bg-secondary">
              Estado
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- @for (v of showVisitors; track $index) {
                        <tr>
                            <td class="col-2 border border-dark">{{v.last_name}}, {{v.name}}</td>
                            <td class="col-2 border border-dark">{{v.document}}</td>
                            <td class="border border-dark col-2 align-items-center text-center"><button (click)="MoreInfo(v)" style="width: 100%;" class="btn btn-info">Ver más</button></td>
                            <td class="col-2">
                                <select style="width: 100%;" class="form-select" name="" id="">
                                   <option value="" class="bg-secondary text-white" selected disabled hidden>Seleccionar</option>
                                    <option (click)="RegisterAccess(v)" class="bg-primary text-light m-0 p-0" value="">Ingreso</option>
                                    <option (click)="RegisterExit(v)" class="bg-primary text-light m-0 p-0" value="">Egreso</option>
                                </select>                                                                                     
                            </td>
                            <td class="col-2 border border-dark"><textarea appAutoSizeTextArea [(ngModel)]="v.observations" name="" id=""></textarea></td>
                        </tr>
                    } -->
        </tbody>
      </table>
      <div class="row align-items-center">
        <div class="col text-end">
          <button class="btn btn-primary me-2" (click)="AddVisitor()">
            Agregar Visitante
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal del escáner QR -->
<div
  class="modal fade"
  id="qrScannerModal"
  tabindex="-1"
  aria-labelledby="qrScannerModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrScannerModalLabel">Escanear Código QR</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="stopScanner()"
        ></button>
      </div>
      <div class="modal-body">
        <ngx-scanner-qrcode
          #scanner
          (event)="handleQrScan($event)"
        ></ngx-scanner-qrcode>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
          (click)="stopScanner()"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal" [class.show]="isModalOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <span class="close" (click)="closeModal()">&times;</span>
    <h2>Información del Visitante</h2>
    <div *ngIf="selectedVisitor">
      <p>
        <strong>Nombre:</strong> {{ selectedVisitor.name }}
        {{ selectedVisitor.last_name }}
      </p>
      <p><strong>Documento:</strong> {{ selectedVisitor.document }}</p>
      <p><strong>Email:</strong> {{ selectedVisitor.email }}</p>
      <p>
        <strong>Tipo de documento:</strong>
        {{ getDocumentType(selectedVisitor) }}
      </p>

      <p><strong>Información del vehículo:</strong></p>
      <div *ngIf="hasVehicles(selectedVisitor); else noVehicle">
        <ul *ngFor="let vehicle of getVehicles(selectedVisitor)">
          <li><strong>Patente:</strong> {{ vehicle.plate }} </li>
          <li><strong>Tipo:</strong> {{ vehicle.vehicle_Type.description }}</li>
        </ul>
      </div>
      <ng-template #noVehicle>
        <p>No tiene registro</p>
      </ng-template>

      <p><strong>Rango de fechas:</strong></p>
      <div *ngIf="selectedVisitor.authRanges.length > 0; else noDays">
        <ul *ngFor="let auth of selectedVisitor.authRanges">
          <li>
            <strong>Desde:</strong>
            {{ auth.init_date | date : "dd/MM/yyyy" }}
            <br />
          </li>
          <li>
            <strong>Hasta:</strong>
            {{ auth.end_date | date : "dd/MM/yyyy" }}
          </li>
        </ul>
      </div>
      <ng-template #noDays>
        <p>No hay fecha cargada.</p>
      </ng-template>
    </div>
  </div>
</div>
