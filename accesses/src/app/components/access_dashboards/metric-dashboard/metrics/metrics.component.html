<div class="container pt-0">
  <!-- Filtors -->
  <div class="row mt-0 sticky-section border-0 rounded-4 p-2 mt-0 shadow mb-3">
    <div class="row">
      <!-- Filtro de fechas -->
      <div class="col d-flex gap-3">
        <div class="col">
          <input
            type="month"
            class="form-control border-1 bg-light"
            [(ngModel)]="periodFrom"
            (ngModelChange)="applyFilters()"
            [max]="periodTo"
            [min]="minDateFrom"
          />
        </div>
        <div class="col">
          <input
            type="month"
            class="form-control border-1 bg-light"
            [(ngModel)]="periodTo"
            (ngModelChange)="applyFilters()"
            [min]="periodFrom"
            [max]="getCurrentYearMonth()" 
            
          />
        </div>
        <div>
          <label for="chartType">Selecciona el tipo de gráfico:</label>
          <select id="chartType" [(ngModel)]="chartType" (change)="onChartTypeChange()">
            <option value="ingresos">Ingresos</option>
            <option value="egresos">Egresos</option>
            <option value="total">Total</option>
          </select>
          
        </div>
      </div>
      <!-- Botones de exportar -->
      <div class="col-auto d-flex gap-1 ms-auto">
        <button
          class="btn btn-primary filterbutton"
          data-bs-toggle="modal"
          title="Filtros Avanzados"
          data-bs-target="#filtrosAvanzados"
        >
          <i class="bi bi-funnel-fill"></i>
        </button>
        <button
          type="button"
          class="btn btn-secondary bi bi-trash filterbutton"
          title="Limpiar Filtros"
          (click)="resetFilters()"
        ></button>
      </div>
    </div>
  </div>

  <!-- ---------------------------------------------------------------------------------------- -->

  <!-- Grilla del dashboard -->
  <div class="row position-relative min-vh-75">
    <!-- Contenedor para cuando un grafico es grande -->
    <div class="container d-flex gap-3" *ngIf="status !== 0">
      <!-- Grafico de columnas -->

      <div class="col-md-9" *ngIf="status === 1">
        <div class="card border-0 shadow-lg rounded-4 h-100 w-100">
          <div class="card-body">
            <div class="align-items-center mb-4">
              <div
                class="back-arrow d-flex justify-content-start"
                (click)="makeBig(0)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="35"
                  height="35"
                  fill="gray"
                  class="bi bi-arrow-left-circle-fill"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0m3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"
                  />
                </svg>
              </div>
              <div>
                <h5
                  class="card-title text-secondary mb-1 d-flex justify-content-center"
                >
                  Cantidad  {{chartType}}
                </h5>
                <small class="text-secondary d-flex justify-content-center"
                  >Rendimiento por día de semana</small
                >
              </div>
            </div>
            <!-- Importante dejar el height en 70% para que no se vaya agrandando sin sentido -->
            <google-chart
              [type]="columnChartType"
              [data]="columnChartData"
              [options]="columnChartOptions"
              class="expanded-chart-content"
              style="width: 100%; height: 70%"
            >
            </google-chart>
          </div>
        </div>
      </div>

      <!-- KPIs para el gráfico de columnas cuando es grande-->
      <div class="col-md-3" *ngIf="status === 1">
        <div class="row">
          <div class="col">
            <div
              class="card border-0 shadow-lg rounded-4 mb-4 hover-scale"
              (click)="makeBig(1)"
            >
              <div class="card-body">
                <h6 class="text-secondary mb-2">
                  Cantidad de Ingresos del Mes Actual
                </h6>
                <h3 class="mb-0">{{this.showCurrentMonth()}} - {{ currentMonthAccessCount }}</h3>
              </div>
            </div>
          </div>
        </div>

        <!-- Promedio Mensual -->
        <div class="row">
          <div class="col mb-3">
            <div
              class="card border-0 shadow-lg mb-3 rounded-4 h-100 w-100"
              style="background-color: #e8f5e9"
            >
              <div class="card-body position-relative">
                <i
                  class="bi bi-star position-absolute top-50 end-0 translate-middle-y me-4"
                  style="font-size: 2.5rem; color: #2e7d32; opacity: 0.8"
                ></i>

                <div class="pe-5">
                  <h6 class="text-secondary mb-2">Mes con más Ingresos</h6>
                  <h3 class="mb-0">
                    {{ monthEntry }} - {{ entriesCount }}
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col mb-3">
            <div
              class="card border-0 shadow-lg mb-3 rounded-4 h-100 w-100"
              style="background-color: #f8d7da"
            >
              <div class="card-body position-relative">
                <i
                  class="bi bi-star position-absolute top-50 end-0 translate-middle-y me-4"
                  style="font-size: 2.5rem; color: #721c24; opacity: 0.8"
                ></i>

                <div class="pe-5">
                  <h6 class="text-secondary mb-2">Mes con más Egresos</h6>
                  <h3 class="mb-0">
                    {{ monthExit }} - {{ exitCount }}
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Ingresos anuales -->
        <div class="row">
          <div class="col mb-3">
            <div
              class="card border-0 shadow-lg mb-3 rounded-4 h-100 w-100"
              style="background-color: #d8ffedde"
            >
              <div class="card-body position-relative">
                <i
                  class="bi bi-house-door position-absolute top-50 end-0 translate-middle-y me-4"
                  style="font-size: 2.5rem; color: #198754; opacity: 0.8"
                ></i>
                <div class="pe-5">
                  <h6 class="text-secondary mb-2">Total de Ingresos Anuales</h6>
                  <h3 class="mb-0">
                    {{ totalAccesCount }}
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="row">
          <div class="col mb-3">
            <div
              class="card border-0 shadow-lg mb-3 rounded-4 h-100 w-100"
              style="background-color: #f8d7da"
            >
              <div class="card-body position-relative">
                <i
                  class="bi bi-house-door position-absolute top-50 end-0 translate-middle-y me-4"
                  style="font-size: 2.5rem; color: #721c24; opacity: 0.8"
                ></i>
                <div class="pe-5">
                  <h6 class="text-secondary mb-2">Total de Egresos Anuales</h6>
                  <h3 class="mb-0">
                    {{ totalExitCount }}
                  </h3>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- KPIs para el gráfico de pie cuando el grafico es grande -->
      <div class="col-md-3" *ngIf="status === 2">
        <!-- Método más usado -->
        <div class="row">
          <div class="col mb-3" *ngFor="let data of uniqueData">
            <div
              class="card border-0 shadow-lg mb-3 rounded-4 h-100 w-100"
              [ngClass]="{
                'bg-success': chartType === 'ingresos',
                'bg-danger': chartType === 'egresos'
              }"
            >
              <div class="card-body position-relative">
                <div class="pe-5">
                  <h6 class="text-secondary mb-2">
                    {{ translateRole(data.userType) }}
                  </h6>
                  <h3 class="mb-0">{{ data.percentage }}%</h3>
                  <!-- Mostrar el porcentaje calculado -->
                  <small class="text-muted">Total: {{ data.count }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card border-0 shadow-lg">

        </div>
      <!-- Grafico de pie -->
      <div class="col-9" *ngIf="status === 2">

        <div class="card border-0 shadow-lg">
            <ng-select
              [items]="availableUserTypes"
              [multiple]="true"
              [searchable]="false"
              bindLabel="label"
              bindValue="value"
              [(ngModel)]="selectedUserTypes"
              (change)="onUserTypeChange()"
              [placeholder]="selectedUserTypes && selectedUserTypes.length ? '' : 'Seleccionar tipos de usuario'">

              <ng-template ng-multi-label-tmp let-items="items">
                <div *ngIf="items.length > 0">
                  {{ items.length }} tipo(s) seleccionado(s)
                </div>
              </ng-template>
          
              <ng-template ng-option-tmp let-item="item" let-index="index">
                <input
                  [id]="'item-' + index"
                  type="checkbox"
                  [checked]="selectedUserTypes.includes(item.value)"
                />
                <span class="ms-2">{{ item.label }}</span>
              </ng-template>
            </ng-select>
          </div>
          


        <div class="card border-0 shadow-lg rounded-4 h-100">
          <div class="card-body">
            <div class="align-items-center mb-4">
              <div
                class="back-arrow d-flex justify-content-start"
                (click)="makeBig(0)"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="35"
                  height="35"
                  fill="gray"
                  class="bi bi-arrow-left-circle-fill"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0m3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"
                  />
                </svg>
              </div>
              <div>
                <h5
                  class="card-title text-secondary mb-1 d-flex justify-content-center"
                >
                  Tipos de usuarios
                </h5>
              </div>
            </div>
            <!-- ACA VA EL GRAFICO DE LINEA DE TIPO DE USUARIOS -->
            <div id="chartContainer">
              <google-chart
                style="width: 900px; height: 800px"
                [type]="barChartType"
                [data]="barChartData"
                [options]="barChartOptions"
              >
              </google-chart>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- --------------------------------------------------------------------------------------------------- -->

    <!-- KPIs generales, cuando se ven todos los graficos juntos -->
    <div class="col-md-2" *ngIf="status === 0">
      <!-- KPI General para Columnas -->
      <div class="row">
        <div class="col">
          <div
            class="card border-0 shadow-lg rounded-4 mb-4 hover-scale"
            (click)="makeBig(1)"
            style="background-color: #d4edda"
          >
            <!-- Color de fondo verde claro -->
            <div class="card-body position-relative">
              <!-- Icono de Ingreso (entrada) -->
              <i
                class="bi bi-arrow-right-circle-fill position-absolute top-50 end-0 translate-middle-y me-4"
                style="font-size: 2.5rem; color: #155724; opacity: 0.8"
              ></i>
              <!-- Icono de ingreso en color verde oscuro -->
              <!-- Contenido existente -->
              <div class="pe-5">
                <!-- Añadimos padding-end para dar espacio al icono -->
                <h6 class="text-secondary mb-2">Ingresos diarios</h6>
                <h3 class="mb-0">
                  {{ currentMonthAccessCount }}
                </h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI General para Columnas -->
      <div class="row">
        <div class="col">
          <div
            class="card border-0 shadow-lg rounded-4 mb-4 hover-scale"
            (click)="makeBig(1)"
            style="background-color: #f8d7da"
          >
            <!-- Color de fondo rojo claro -->
            <div class="card-body position-relative">
              <!-- Icono de Egreso (salida) -->
              <i
                class="bi bi-arrow-left-circle-fill position-absolute top-50 end-0 translate-middle-y me-4"
                style="font-size: 2.5rem; color: #721c24; opacity: 0.8"
              ></i>
              <!-- Icono de egreso en color rojo oscuro -->
              <!-- Contenido existente -->
              <div class="pe-5">
                <!-- Añadimos padding-end para dar espacio al icono -->
                <h6 class="text-secondary mb-2">Egresos diarios</h6>
                <h3 class="mb-0">
                  {{ currentMonthExitCount }}
                </h3>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI General para ingresos pico por día de la semana -->
      <div class="row">
        <div class="col">
          <div
            class="card border-0 shadow-lg rounded-4 mb-4 hover-scale"
            (click)="makeBig(1)"
          >
            <div class="card-body">
              <h6 class="text-secondary mb-2">
                Pico de Ingresos de esta Semana
              </h6>
              <h3 class="mb-0">{{ accessCount }}</h3>
              <small class="text-muted">Día de la semana: </small>
              <span>{{ dayWithMostAccesses }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div
            class="card border-0 shadow-lg rounded-4 mb-4 hover-scale"
            (click)="makeBig(1)"
          >
            <div class="card-body">
              <h6 class="text-secondary mb-2">
                Pico de Egresos de esta Semana
              </h6>
              <h3 class="mb-0">{{ exitsCountPeak }}</h3>
              <small class="text-muted">Día de la semana: </small>
              <span>{{ dayWithMostExits }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- KPI General para ingresos pico por día de la semana -->
      <div class="row" *ngIf="chartType !== 'egresos'">
        <div class="col">
            <div class="card border-0 shadow-lg rounded-4 mb-4 hover-scale" (click)="redirect(redirectKpis.guardEntries, 'guardEntries')">
              <div class="card-body">
                <h6 class="text-secondary mb-2">Guardia con mayor registro de Ingresos</h6>
                <h3 class="mb-0">{{ redirectKpis.guardEntries.name }}</h3>
                <small class="text-muted">Cantidad: {{ redirectKpis.guardEntries.count }} </small>
                <span>{{ dayWithMostAccesses }}</span>
              </div>
            </div>
          </div>
          
    </div>
    <div class="row" *ngIf="chartType !== 'ingresos'">
        <div class="col">
            <div class="card border-0 shadow-lg rounded-4 mb-4 hover-scale" (click)="redirect(redirectKpis.guardExits, 'guardExits')">
              <div class="card-body">
                <h6 class="text-secondary mb-2">Guardia con mayor registro de Egresos</h6>
                <h3 class="mb-0">{{ redirectKpis.guardExits.name }}</h3>
                <small class="text-muted">Cantidad: {{ redirectKpis.guardExits.count }} </small>
                <span>{{ dayWithMostAccesses }}</span>
              </div>
            </div>
          </div>
          
    </div>
    <div class="row">
        <div class="col">
            <div class="card border-0 shadow-lg rounded-4 mb-4 hover-scale" (click)="redirect(redirectKpis.neighborAuthorizations, 'neighborAuthorizations')">
              <div class="card-body">
                <h6 class="text-secondary mb-2">Vecino con más personas autorizadas</h6>
                <h3 class="mb-0">{{ redirectKpis.neighborAuthorizations.name }}</h3>
                <small class="text-muted">Cantidad: {{ redirectKpis.neighborAuthorizations.count }} </small>
                <!-- <span>{{ dayWithMostAccesses }}</span> -->
              </div>
            </div>
          </div>
          
    </div>
    </div>

    <!-- Grafico de columnas  -->
    <div
      class="col-12 col-lg-5"
      *ngIf="status === 0"
      style="height: 100%"
    >
      <div class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale" (click)="makeBig(1)">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-0"> <!-- Cambiado a justify-content-between -->
            <h4 class="card-title m-0 fw-semibold">Comparación de {{ capitalizeFirstLetter(chartType) }}</h4> <!-- Simplificado -->
            <button type="button"
                class="btn btn-sm btn-link text-muted bi bi-arrows-angle-expand fs-5" 
                title="Expandir" 
                (click)="makeBig(1)">
            </button>
          </div>
          <hr class="mt-1 mb-0">
          <google-chart class="mt-0"
            style="width: 100%; height: 400px"
            [type]="columnChartType"
            [data]="columnChartData"
            [options]="columnChartOptions">
          </google-chart>
        </div>
      </div>
    </div>

    <!-- Grafico top 5 -->
    <div class="col-12 col-lg-5" *ngIf="status === 0">
      <div class="mb-4">
        <div
          class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale"
          (click)="makeBig(2)"
        >
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-0"> <!-- Cambiado a justify-content-between -->
              <h4 class="card-title m-0 fw-semibold">Cantidad de {{ capitalizeFirstLetter(chartType) }}</h4> <!-- Simplificado -->
              <button type="button"
                  class="btn btn-sm btn-link text-muted bi bi-arrows-angle-expand fs-5" 
                  title="Expandir" 
                  (click)="makeBig(2)">
              </button>
            </div>
            <div class="d-flex justify-content-left align-items-center mb-0">
              <h6 class="text-secondary">Según Tipo de Ingresante</h6>
            </div>
            <hr class="mt-1 mb-3">
            <!-- ACA VA EL GRAFICO DE LINEA DE TIPOS DE USUARIOS -->
            <google-chart 
              style="width: 100%; height: 100%"
              [type]="barChartType"
              [data]="barChartData"
              [options]="barChartOptions"
              [height]="barChartOptions.height"
            >
            </google-chart>
          </div>
        </div>

        <div class="mt-4">
          <div
            class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale"
            (click)="makeBig(2)"
          >
            <div class="card-body">
              <div
                class="d-flex justify-content-center align-items-center mb-0"
              >
                <div>
                  <h4 class="card-title fw-semibold mb-1 text-center"> TOP 5</h4>
                  <h6 class="fw-medium">Usuarios con más Ingresos/Egresos</h6>
                </div>
              </div>

              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Ingresos</th>
                    <th>Egresos</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let user of topUser">
                    <td>{{ user[0] }}</td>
                    <!-- Nombre -->
                    <td>{{ translateRole(user[1]) }}</td>
                    <!-- Rol traducido -->
                    <td>{{ user[2] }}</td>
                    <!-- Entradas -->
                    <td>{{ user[3] }}</td>
                    <!-- Salidas -->
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
    <!-- Grafico top 5 -->

    <div class="col-12 col-lg-10" *ngIf="status === 0">

    </div>

  </div>
</div>

<!-- Modal de info -->
<div class="modal fade" id="infoModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          Información del Dashboard
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Bienvenido al Dashboard de Accesos. Este panel te permite:
        </p>
        <ul>
          <li>
            Visualizar estadísticas de Ingresos/Egresos en tiempo real,
            incluyendo gráficos y tablas detalladas.
          </li>
          <li>Generar reportes personalizados basados en fechas y años.</li>
          <li>
            Acceder a un historial completo de tipos de personas que ingresan y
            más.
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
