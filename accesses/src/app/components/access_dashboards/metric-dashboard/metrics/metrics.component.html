<div class="container pt-0">
  <!-- Filtros -->
  <div class="row mt-0 sticky-section border-0 rounded-4 p-2 mt-0 shadow mb-3">
    <div class="row">
      <!-- Filtro de fechas -->
      <div class="col d-flex gap-3">
        <div class="col">
          <input
            type="month"
            class="form-control border-1 bg-light"
            [(ngModel)]="periodFrom"
            (ngModelChange)="applyFilters()"
            [max]="periodTo"
            [min]="minDateFrom"
          />
        </div>
        <div class="col">
          <input
            type="month"
            class="form-control border-1 bg-light"
            [(ngModel)]="periodTo"
            (ngModelChange)="applyFilters()"
            [min]="periodFrom"
            [max]="getCurrentYearMonth()" 
          />
        </div>
   
      </div>
      <!-- Botones de exportar -->
      <div class="col-auto d-flex gap-2 ms-auto">
        <button
          class="btn btn-primary filterbutton"
          data-bs-toggle="modal"
          title="Filtros Avanzados"
          data-bs-target="#filtrosAvanzados"
        >
          <i class="bi bi-funnel-fill"></i>
        </button>
        <button
          type="button"
          class="btn btn-secondary bi bi-trash filterbutton"
          title="Limpiar Filtros"
          (click)="resetFilters()"
        ></button>
      </div>
    </div>
  </div>
  <div class="modal fade" id="filtrosAvanzados" tabindex="-1" aria-labelledby="filtrosAvanzadosLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filtrosAvanzadosLabel">Filtros Avanzados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="input-group-with-label"></div>
          <label for="chartType" class="form-label">Tipo de Gráfico</label>
          <select id="chartType" class="form-select" [(ngModel)]="chartType" (change)="onChartTypeChange()">
            <option value="ingresos">Ingresos</option>
            <option value="egresos">Egresos</option>
            <option value="total">Ambos</option>
          </select>
          
        </div>
        <div class="col">
          <div class="input-group-with-label">
            <div class="input-group">
              <ng-select [items]="availableUserTypes" [multiple]="true" [closeOnSelect]="false" [searchable]="true"
                bindLabel="label" bindValue="value" [clearable]="false" [(ngModel)]="selectedUserTypes"
                (change)="applyFilters()"
                [placeholder]="selectedUserTypes.length ? '' : 'Seleccionar tipo de ingresante'">
                <ng-template ng-multi-label-tmp let-items="items">
                  <div *ngIf="items.length > 0">({{items.length}}) Seleccionados</div>
                </ng-template>
                <ng-template ng-option-tmp let-item="item" let-item$="item$" let-index="index">
                  <input id="ingresante-{{index}}" type="checkbox" [checked]="item$.selected" />
                  <span class="ms-2">{{item.label}}</span>
                </ng-template>
              </ng-select>
            </div>
          </div>
        </div>



      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>

      </div>
    </div>
  </div>
</div>

  <!-- Grilla del dashboard -->
  <div class="row position-relative min-vh-75">
    <!-- Contenedor para cuando un grafico es grande -->
    <div class="container d-flex gap-3" *ngIf="status !== 0">

      <!-- KPIs para el gráfico de columnas cuando es grande-->
      <div class="col-md-4" *ngIf="status === 1">
        <div class="row">
          <div class="col">
            <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)">
              <div class="card-body">
                <h5 class="fw-semibold mb-2">
                  Cantidad de Ingresos del Mes Actual
                </h5>
                <h4 class="mb-0">{{this.showCurrentMonth()}} | {{ currentMonthAccessCount }}</h4>
              </div>
            </div>
          </div>
        </div>

        <!-- Promedio Mensual -->
         <div class="row">
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4" style="background-color: #e8f5e9">
              <div class="card-body position-relative">
                <h6 class="fw-semibold mb-2 p-0">Mes con más Ingresos</h6>
                <div class="d-flex justify-content-between align-items-center mb-0">
                  <h5 class="mb-0">
                    {{ monthEntry }} | {{ entriesCount }}
                  </h5>
                  <i class="bi bi-star" style="font-size: 2rem; color: #2e7d32; opacity: 0.8"></i>
                </div>
              </div>
            </div>
          </div>
 
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4 h-100 w-98" style="background-color: #f8d7da">
              <div class="card-body position-relative">
                <h6 class="fw-semibold mb-2 p-0">Mes con más Ingresos</h6>
                <div class="d-flex justify-content-between align-items-center mb-0">
                  <h5 class="mb-0">
                    {{ monthExit }} | {{ exitCount }}
                  </h5>
                  <i class="bi bi-star" style="font-size: 2rem; color: #721c24; opacity: 0.8"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- FIN Promedio Mensual -->

        <!-- Total Ingresos anuales -->
        <div class="row">
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4 w-100" style="background-color: #d8ffedde">
              <div class="card-body py-1">
                <div class="row">
                  <div class="col-12">
                    <h6 class="fw-semibold pt-2 mb-2 p-0">Total de Ingresos Anuales</h6>
                  </div>
                </div>
                <div class="row align-items-center">
                  <div class="col">
                    <h3 class="mb-0 ps-2">{{ totalAccesCount }}</h3>
                  </div>
                  <div class="col-auto">
                    <i class="bi bi-house-door" style="font-size: 2.5rem; color: #198754; opacity: 0.8"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        
          <div class="col mb-3">
            <div class="card border-0 shadow-lg mb-2 rounded-4 w-100" style="background-color: #f8d7da">
              <div class="card-body py-1">
                <div class="row">
                  <div class="col-12">
                    <h6 class="fw-semibold pt-2 mb-2 p-0">Total de Egresos Anuales</h6>
                  </div>
                </div>
                <div class="row align-items-center">
                  <div class="col">
                    <h3 class="mb-0 ps-2">{{ totalExitCount }}</h3>
                  </div>
                  <div class="col-auto">
                    <i class="bi bi-house-door" style="font-size: 2.5rem; color: #721c24; opacity: 0.8"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
      <!-- Grafico de columnas -->
      <div class="col-md-8 mb-2" *ngIf="status === 1">
        <div class="card border-0 shadow-lg rounded-4 h-90 w-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <!-- Left-aligned titles -->
              <div>
                <h4 class="fw-semibold card-title mb-2">Cantidad de {{capitalizeFirstLetter(chartType)}}</h4>
                <h6 class="text-secondary mb-0">Rendimiento por cada día de la semana</h6>
              </div>
              
              <!-- Centered arrow -->
              <div class="back-arrow ms-auto d-flex align-items-center" (click)="makeBig(0)">
                <i class="bi bi-arrow-left"></i>
              </div>
            </div>
            <hr class="m-0">
            <google-chart
              [type]="columnChartType"
              [data]="columnChartData"
              [options]="columnChartOptions"
              class="expanded-chart-content"
              style="width: 100%; height: 287px"
            >
            </google-chart>
          </div>
        </div>
      </div>

      <!-- KPIs para el gráfico de pie cuando el grafico es grande -->
      <div class="col-md-4" *ngIf="status === 2">
        <!-- Método más usado -->
        <div class="row">
          <div class="col mb-3 me-0" *ngFor="let data of uniqueData">
            <div class="card border-0 shadow-lg mb-2 rounded-4 h-100 w-100"
              [ngClass]="{
                'bg-success': chartType === 'ingresos',
                'bg-danger': chartType === 'egresos'
              }">
              <div class="card-body position-relative">
                <div class="pe-5">
                  <h5 class="mb-3 p-0 fw-semibold">
                    {{ translateRole(data.userType) }}
                  </h5>
                  <h4 class="mb-1">{{ data.percentage }}%</h4>
                  <small class="text-muted mb-0">Total: {{ data.count }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grafico de pie -->
      <div class="col-8" *ngIf="status === 2">
        <!-- <div class="card border-0 shadow-lg">
          <ng-select
            [items]="availableUserTypes"
            [multiple]="true"
            [searchable]="false"
            bindLabel="label"
            bindValue="value"
            [(ngModel)]="selectedUserTypes"
            (change)="onUserTypeChange()"
            [placeholder]="selectedUserTypes && selectedUserTypes.length ? '' : 'Seleccionar tipos de usuario'">
            <ng-template ng-multi-label-tmp let-items="items">
              <div *ngIf="items.length > 0">
                {{ items.length }} tipo(s) seleccionado(s)
              </div>
            </ng-template>
            <ng-template ng-option-tmp let-item="item" let-index="index">
              <input
                [id]="'item-' + index"
                type="checkbox"
                [checked]="selectedUserTypes.includes(item.value)"
              />
              <span class="ms-2">{{ item.label }}</span>
            </ng-template>
          </ng-select>
        </div> -->

        <div class="ms-1 card border-0 shadow-lg rounded-4">
          <div class="card-body">
            <div class="d-flex align-items-center mb-0">
              <!-- Título alineado a la izquierda -->
              <h5 class="card-title mb-2 fw-semibold">Comparación de {{ capitalizeFirstLetter(chartType) }} según Tipos de Ingresante</h5>
              <!-- Flecha de regreso alineada a la derecha -->
              <div class="back-arrow pb-2 ms-auto" (click)="makeBig(0)">
                <i class="bi bi-arrow-left"></i>
              </div>
            </div>
            <hr class="mt-1 mb-0">
            <div id="chartContainer mt-0">
              <google-chart class="mt-0" style="width: 720px; height: 338px" [type]="barChartType" [data]="barChartData" [options]="barChartOptions">
              </google-chart>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- KPIs generales, cuando se ven todos los graficos juntos -->
    <div class="col-md-2" *ngIf="status === 0">
      <!-- KPI General para Columnas -->
      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 p-0 hover-scale" (click)="makeBig(1)" style="background-color: #d4edda">
            <div class="card-body">
              <!-- Título en la primera fila -->
              <h5 class="mb-1 p-0 fw-semibold">Ingresos diarios</h5>
              
              <!-- Contenedor para variable e ícono -->
              <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 ps-2">
                  {{ currentMonthAccessCount }}
                </h3>
                <i class="bi bi-box-arrow-right pe-1" style="font-size: 2.5rem; color: #155724; opacity: 0.8"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI General para Columnas -->
      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)" style="background-color: #f8d7da">
            <div class="card-body">
              <!-- Título en la primera fila -->
              <h5 class="mb-1 p-0 fw-semibold">Egresos diarios</h5>
              
              <!-- Contenedor para variable e ícono -->
              <div class="d-flex justify-content-between align-items-center">
                <h3 class="mb-0 ps-2">
                  {{ currentMonthExitCount }}
                </h3>
                <i class="bi bi-box-arrow-left pe-2" style="font-size: 2.5rem; color: #721c24; opacity: 0.8"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI General para ingresos pico por día de la semana -->
      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)">
            <div class="card-body">
              <h6 class="mb-1 p-0 fw-semibold">
                Día con más Ingresos esta Semana
              </h6>
              <div class="d-flex justify-content-between align-items-center">
                @if(accessCount > 0){
                  <h5 class="mb-0 fw-medium">{{ capitalizeFirstLetter(dayWithMostAccesses) }} | {{ accessCount }}</h5>
                  <i class="bi bi-box-arrow-right ps-1" style="font-size: 2rem; color: #155724; opacity: 0.8"></i>
                } @else {
                  <h4 class="mb-0"><i class="bi bi-dash-lg"></i></h4>
                  <i class="bi bi-box-arrow-right ps-1" style="font-size: 2rem; color: #155724; opacity: 0.8"></i>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="makeBig(1)">
            <div class="card-body">
              <h6 class="mb-2 p-0 fw-semibold">
                Día con más Egresos esta Semana
              </h6>
              <div class="d-flex justify-content-between align-items-center">
                @if(exitsCountPeak > 0){
                  <h5 class="mb-0 p-0 fw-medium">{{ capitalizeFirstLetter(dayWithMostExits) }} | {{ exitsCountPeak }}</h5>
                  <i class="bi bi-box-arrow-left ps-1" style="font-size: 2rem; color: #721c24; opacity: 0.8"></i>
                } @else {
                  <h4 class="mb-0 p-0"><i class="bi bi-dash-lg"></i></h4>
                  <i class="bi bi-box-arrow-left ps-1" style="font-size: 2rem; color: #721c24; opacity: 0.8"></i>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

 

      <!-- KPI para vecino con más autorizaciones -->
      <div class="row">
        <div class="col">
          <div class="card border-0 shadow-lg rounded-4 mb-3 hover-scale" (click)="redirect(redirectKpis.neighborAuthorizations, 'neighborAuthorizations')">
            <div class="card-body">
              <h6 class="mb-2 fw-semibold">Vecino con más personas autorizadas</h6>
              <h5 class="mb-0 fw-medium">{{ redirectKpis.neighborAuthorizations.name }} | {{ redirectKpis.neighborAuthorizations.count }}</h5>
            </div>
          </div>
        </div>
      </div>
    </div>




    <!-- Gráfico de columnas -->
    <div class="col-12 col-lg-5" *ngIf="status === 0" style="height: 100%">

      <div class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale" (click)="makeBig(2)">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-0">
            <h4 class="card-title m-0 fw-semibold">Cantidad de {{ capitalizeFirstLetter(chartType) }}</h4>
            <button type="button"
                class="btn btn-sm btn-link text-muted bi bi-arrows-angle-expand fs-5" 
                title="Expandir" 
                (click)="makeBig(2)">
            </button>
          </div>
          <div class="d-flex justify-content-left align-items-center mb-0">
            <h6 class="text-secondary">Según Tipo de Ingresante</h6>
          </div>
          <hr class="mt-1 mb-3">
          <google-chart 
            style="width: 100%; height: 505px"
            [type]="barChartType"
            [data]="barChartData"
            [options]="barChartOptions"
            [height]="barChartOptions.height">
          </google-chart>
        </div>
      </div>

         <!-- KPIs de guardias movidos aquí -->
        <div class="row mt-3">
          <!-- KPI para guardia con más ingresos -->
          <div class="col-6 mt-0" *ngIf="chartType !== 'egresos'">
            <div class="card border-0 shadow-lg rounded-4 mb-4 hover-scale" (click)="redirect(redirectKpis.guardEntries, 'guardEntries')">
              <div class="card-body">
                <h6 class="mb-2 fw-semibold">Guardia con mayor registro de Ingresos</h6>
                <div class="row align-items-center">
                  <div class="col">
                    <h5 class="mb-0 fw-medium">{{ redirectKpis.guardEntries.name }} | {{ redirectKpis.guardEntries.count }}</h5>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!--* KPI para guardia con más egresos *-->
          <div class="col-6 mt-0" *ngIf="chartType !== 'ingresos'">
            <div class="card border-0 shadow-lg rounded-4 mb-4 hover-scale" (click)="redirect(redirectKpis.guardExits, 'guardExits')">
              <div class="card-body">
                <h6 class="mb-2 fw-semibold">Guardia con mayor registro de Egresos</h6>
                <div class="row align-items-center">
                  <div class="col">
                    <h5 class="mb-0 fw-medium">{{ redirectKpis.guardExits.name }} | {{ redirectKpis.guardExits.count }}</h5>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>
    <!-- Gráfico top 5 -->
    <div class="col-12 col-lg-5" *ngIf="status === 0">
      <div class="mb-3">
        <!--  -->
        <div class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale" (click)="makeBig(1)">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-0">
              <h4 class="card-title m-0 fw-semibold">Comparación de {{ capitalizeFirstLetter(chartType) }}</h4>
              <button type="button"
                  class="btn btn-sm btn-link text-muted bi bi-arrows-angle-expand fs-5" 
                  title="Expandir" 
                  (click)="makeBig(1)">
              </button>
            </div>
            <hr class="mt-1 mb-0">
            <google-chart class="mt-0"
              style="width: 100%; height: 300px"
              [type]="columnChartType"
              [data]="columnChartData"
              [options]="columnChartOptions">
            </google-chart>
          </div>
        </div>
        <!--  -->
        <div class="mt-3">
          <div class="card border-0 shadow-lg rounded-4 h-100 transition-all hover-scale" (click)="makeBig(2)">
            <div class="card-body">
              <div class="d-flex justify-content-center align-items-center mb-0">
                <div>
                  <h4 class="card-title fw-semibold mb-1 text-center">TOP 5</h4>
                  <h6 class="fw-medium">Ingresantes con más Ingresos/Egresos</h6>
                </div>
              </div>

              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Ingresos</th>
                    <th>Egresos</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let user of topUser">
                    <td>{{ user[0] }}</td>
                    <td>{{ translateRole(user[1]) }}</td>
                    <td>{{ user[2] }}</td>
                    <td>{{ user[3] }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de info -->
<div class="modal fade" id="infoModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          Información del Dashboard
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>
          Bienvenido al Dashboard de Accesos. Este panel te permite:
        </p>
        <ul>
          <li>
            Visualizar estadísticas de Ingresos/Egresos en tiempo real,
            incluyendo gráficos y tablas detalladas.
          </li>
          <li>Generar reportes personalizados basados en fechas y años.</li>
          <li>
            Acceder a un historial completo de tipos de personas que ingresan y
            más.
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>