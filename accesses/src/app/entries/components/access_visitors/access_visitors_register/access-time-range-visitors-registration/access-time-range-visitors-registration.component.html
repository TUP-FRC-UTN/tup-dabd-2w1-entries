<div class="card mt-3">
  <div class="card-body">
    <h5 class="card-title">Días y Horarios Autorizados</h5>
    <form [formGroup]="form">
      <div class="row">
        <div class="col-md-6 mb-3">
          <div class="d-flex align-items-center">
            <label for="startDate" class="form-label me-3">Desde</label>
            <input type="date" class="form-control" id="startDate" formControlName="startDate" [disabled]="areDatesDisabled"
              [readonly]="areDatesReadonly" [class.bg-gray-100]="areDatesReadonly" required>
          </div>
        </div>
        <div class="col-md-6 mb-3">
          <div class="d-flex align-items-center">
            <label for="endDate" class="form-label me-3">Hasta</label>
            <input type="date" class="form-control" id="endDate" formControlName="endDate" [disabled]="areDatesDisabled"
              [class.bg-gray-100]="areDatesReadonly" required>
          </div>
        </div>
      </div>

      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-10">
          <div class="btn-group d-flex flex-wrap" role="group" aria-label="Días de visita">
            @for (day of days; track $index) {
              <ng-container>
                <input type="checkbox" class="btn-check" [id]="'btncheck' + ($index + 1)" [formControlName]="day.name" [disabled]="isAllowedDay(day)" autocomplete="off">
                <label class="btn" [class.btn-primary]="form.get(day.name)?.value" [class.btn-outline-primary]="!form.get(day.name)?.value" [class.disabled]="isAllowedDay(day)" [for]="'btncheck' + ($index + 1)">
                  {{ day.name }}
                </label>
              </ng-container>
            }
          </div>
        </div>

        <div class="col-md-2 ps-3"> 
          <button class="btn btn-secondary w-100" (click)="addAllDays()">Todos</button>
        </div>

        <div class="col-md-12">
          <div class="row g-4">
            <div class="col-md-5">
              <div class="d-flex align-items-center">
                <label for="initHour" class="form-label me-3">Hora Inicio</label>
                <div class="flex-grow-1">
                  <input
                    type="time"
                    class="form-control form-control-sm"
                    id="initHour"
                    formControlName="initHour"
                    placeholder="Desde"
                    min="00:00"
                    max="23:59"
                    step="60"
                    [class.is-invalid]="form.get('initHour')?.touched && form.get('initHour')?.invalid"
                    required
                  >
                  <div class="invalid-feedback mt-1" *ngIf="form.get('initHour')?.touched">
                    <span *ngIf="form.get('initHour')?.errors?.['required']">
                      La hora de inicio es requerida
                    </span>
                    <span *ngIf="form.get('initHour')?.errors?.['invalidFormat']">
                      Formato inválido. Use HH:mm
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-5">
              <div class="d-flex align-items-center">
                <label for="endHour" class="form-label me-3">Hora Fin</label>
                <div class="flex-grow-1">
                  <input
                    type="time"
                    class="form-control form-control-sm"
                    id="endHour"
                    formControlName="endHour"
                    placeholder="Hasta"
                    min="00:00"
                    max="23:59"
                    step="60"
                    [class.is-invalid]="form.get('endHour')?.touched && form.get('endHour')?.invalid"
                    required
                  >
                  <div class="invalid-feedback mt-1" *ngIf="form.get('endHour')?.touched">
                    <span *ngIf="form.get('endHour')?.errors?.['required']">
                      La hora de fin es requerida
                    </span>
                    <span *ngIf="form.get('endHour')?.errors?.['invalidFormat']">
                      Formato inválido. Use HH:mm
                    </span>
                    <span *ngIf="form.get('endHour')?.errors?.['invalidTimeRange']">
                      La hora de fin debe ser posterior a la hora de inicio
                    </span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <button
                class="btn btn-primary w-100 btn-sm"
                type="button"
                (click)="agregarDiasPermitidos()"
                [disabled]="form.get('initHour')?.invalid || form.get('endHour')?.invalid"
              >
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
          </div>
        </div>
      </div>


      <div *ngIf="allowedDays.length > 0" class="table-responsive mt-4">
        <table class="table table-striped table-fixed">
          <thead>
            <tr>
              <th>Día</th>
              <th>Horario</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let schedule of allowedDays">
              <td>{{ schedule.day.name }}</td>
              <td>{{ formatHour(schedule) }}</td>
              <td>
                <button class="btn btn-danger btn-sm" (click)="deleteAllowedDay(schedule)">Borrar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </form>
  </div>
</div>
